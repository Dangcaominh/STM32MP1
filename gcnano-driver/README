Compilation of the gcnano kernel module:
1. Pre-requisite
2. Initialize cross-compilation via SDK
3. Prepare gcnano kernel module source
4. Manage gcnano kernel module source code with GIT
5. Compile the gcnano kernel module
6. Update software on board
7. Update Starter Package with gcnano kernel module compilation outputs

----------------
1. Pre-requisite
----------------
 - OpenSTLinux SDK must be installed.
 - Linux Kernel source must be installed and built

---------------------------------------
2. Initialize cross-compilation via SDK
---------------------------------------
Source SDK environment:
    $ source <path to SDK>/environment-setup

To verify that your cross-compilation environment is set-up correctly:
    $ set | grep CROSS_COMPILE

  If the variable CROSS_COMPILE has a value:
   - arm-ostl-linux-gnueabi- for 32 bits architecture (for example STM32MP1)
   - aarch64-ostl-linux- for 64 bits architecture (for example STM32MP2)
  Then everything is set-up correctly

Warning: the environment variables are valid only on the shell session where you have
sourced the sdk environment.

------------------------
3. Prepare gcnano kernel module source
------------------------
If not already done, extract the sources from Developer Package tarball, for example:
    $ tar xf en.SOURCES-stm32mp*-*.tar.xz

In the gcnano driver source directory (sources/*/gcnano-driver-stm32mp-6.4.21-r1-r0),
you have one gcnano kernel module source tarball:
   - gcnano-driver-stm32mp-6.4.21-r1-r0.tar.xz

If you would like to have a git management for the source code move to
to section 4 [Management of gcnano kernel module source code with GIT].

Otherwise, to manage gcnano kernel module source code without git, you must extract the
tarball now:

    $> tar xf gcnano-driver-stm32mp-6.4.21-r1-r0.tar.xz
    $> cd gcnano-driver-stm32mp-6.4.21-r1

You can now move to section 5 [Compile gcnano kernel module source code].

-------------------------------------
4. Manage gcnano kernel module source code with GIT
-------------------------------------
If you like to have a better management of change made on gcnano kernel module source,
you have 2 solutions to use git

4.1 Get STMicroelectronics gcnano kernel module source from GitHub
----------------------------------------------------
    URL: https://github.com/STMicroelectronics/gcnano-binaries.git
    Branch: gcnano-6.4.21-binaries
    Revision: 7c181cacf89f918039e64934fdc33fe817a052cd

    $ git clone https://github.com/STMicroelectronics/gcnano-binaries.git
    $ git checkout -b WORKING 7c181cacf89f918039e64934fdc33fe817a052cd

4.2 Create Git from tarball
---------------------------
    $ tar xf gcnano-driver-stm32mp-6.4.21-r1-r0.tar.xz
    $ cd gcnano-driver-stm32mp-6.4.21-r1
    $ test -d .git || git init . && git add . && git commit -m "gcnano kernel module source code" && git gc
    $ git checkout -b WORKING

----------------
5. Compile the gcnano kernel module
----------------
OpenSTLinux SDK must be installed.

* Compile and install the gcnano kernel module
    * First define KERNEL_BUILDDIR variable to expose kernel source code
    $> KERNEL_BUILDDIR="../../linux-stm32mp-<KERNELVERSION>-stm32mp-<RELEASE>/build"
    * Select the platform between "st-mp1" or "st-mp2"
    $> SOC_PLATFORM=st-mp<X>
    * Build kernel module
    $> make SOC_PLATFORM=${SOC_PLATFORM} DEBUG=0 O="${KERNEL_BUILDDIR}" M="${PWD}" AQROOT="${PWD}" -C ${KERNEL_BUILDDIR}

---------------------------
6. Update software on board
---------------------------

6.1 Update via network
----------------------
    Copy kernel modules:
    $ scp galcore.ko root@<ip of board>:/lib/modules/<kernel version>/extra

    Generate a list of module dependencies (modules.dep) and a list of symbols
    provided by modules (modules.symbols):
    $ ssh root@<ip of board> /sbin/depmod -a
    Synchronize data on disk with memory
    $ ssh root@<ip of board> sync
    Reboot the board in order to take update into account
    $ ssh root@<ip of board> reboot

---------------------------
7. Generate new Starter Package with gcnano kernel module compilation outputs
---------------------------

If not already done, extract the artifacts from Starter Package tarball, for example:
    # tar xf en.FLASH-stm32mp*-*.tar.xz

Update Starter package with just compiled kernel module galcore.ko:
    #> mkdir -p <your_starter_package_dir_path>/rootfs_mounted
    #> sudo mount -o loop <your_starter_package_dir_path>/images/stm32mp*/st-image-weston-openstlinux-weston-stm32mp*.ext4 <your_starter_package_dir_path>/rootfs_mounted
    #> sudo mkdir -p <your_starter_package_dir_path>/rootfs_mounted/lib/modules/6.6.78/updates

Cleanup Starter Package from original gcnano kernel module artifacts first
    #> sudo rm -vf <your_starter_package_dir_path>/rootfs_mounted/lib/modules/6.6.78/updates/galcore.ko

    #> sudo cp -vf */galcore.ko  <your_starter_package_dir_path>/rootfs_mounted/lib/modules/6.6.78/updates/
    #> sudo depmod -a -b <your_starter_package_dir_path>/rootfs_mounted $(\ls <your_starter_package_dir_path>/rootfs_mounted/lib/modules)
    #> sudo umount <your_starter_package_dir_path>/rootfs_mounted
    #> rmdir <your_starter_package_dir_path>/rootfs_mounted

---------------------------
8. Example of compilation usage
---------------------------
    $@E> cd gcnano-driver-stm32mp-6.4.21-r1-r0
    $@E> tar xf gcnano-driver-stm32mp-6.4.21-r1-r0.tar.xz
    $@E> cd gcnano-driver-stm32mp-6.4.21-r1
    $@E> test -d .git || git init . && git add . && git commit -m "gcnano kernel module source code" && git gc
    $@E> git checkout -b WORKING

    $ cd ..
    $ cd ..
    $@P> cd gcnano-driver-stm32mp-6.4.21-r1-r0
    $@P> cd gcnano-driver-stm32mp-6.4.21-r1

    $@C> KERNEL_COMPONENT_VERSION=$(ls -1 ../../ | grep linux-stm32mp | head -n1)
    $@C> KERNEL_BUILDDIR="../../$KERNEL_COMPONENT_VERSION/build"

    $@C> make SOC_PLATFORM=st-mp1 DEBUG=0 O="../../$KERNEL_COMPONENT_VERSION/build" M="${PWD}" AQROOT="${PWD}" -C ${KERNEL_BUILDDIR}

    To strip the kernel modules (Optionally):
    @> find . -name "*.ko" | xargs $STRIP --strip-debug --remove-section=.comment --remove-section=.note --preserve-dates galcore.ko

   # To deploy
   $@F> export FIP_DEPLOYDIR_ROOT=<your_deploy_dir_path>
   $@F> mkdir -p ${FIP_DEPLOYDIR_ROOT}/kernel/modules/lib/modules/$(ls -1 ${FIP_DEPLOYDIR_ROOT}/kernel/modules/lib/modules/)/extra
   $@F> mkdir -p ${FIP_DEPLOYDIR_ROOT}/kernel/modules_stripped/lib/modules/$(ls -1 ${FIP_DEPLOYDIR_ROOT}/kernel/modules/lib/modules/)/extra

   $@F> cp galcore.ko ${FIP_DEPLOYDIR_ROOT}/kernel/modules/lib/modules/$(ls -1 ${FIP_DEPLOYDIR_ROOT}/kernel/modules/lib/modules/)/extra
   $@F> cp galcore.ko ${FIP_DEPLOYDIR_ROOT}/kernel/modules_stripped/lib/modules/$(ls -1 ${FIP_DEPLOYDIR_ROOT}/kernel/modules/lib/modules/)/extra
   $@F> find ${FIP_DEPLOYDIR_ROOT}/kernel/modules_stripped/lib/modules/$(ls -1 ${FIP_DEPLOYDIR_ROOT}/kernel/modules/lib/modules/)/extra -name "*.ko" | xargs $STRIP --strip-debug --remove-section=.comment --remove-section=.note --preserve-dates
